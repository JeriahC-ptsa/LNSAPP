{% extends 'base.html' %}
{% block title %}Modules & Minitasks{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <h1 class="mb-4"><i class="bi bi-book me-2"></i>Modules & Mini-Tasks Management</h1>

  <!-- Action Buttons -->
  <div class="mb-4">
    <a href="{{ url_for('assign_modules_bulk') }}" class="btn btn-success">
      <i class="bi bi-clipboard-check me-2"></i>Assign Modules to Students
    </a>
    <a href="{{ url_for('view_module_assignments') }}" class="btn btn-info">
      <i class="bi bi-list-check me-2"></i>View Module Assignments
    </a>
  </div>

  <!-- Add Module Card -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Add New Module</h5>
    </div>
    <div class="card-body">
      <form method="POST" action="{{ url_for('add_module') }}">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label"><strong>Module Name</strong> <span class="text-danger">*</span></label>
            <input class="form-control" name="module_name" placeholder="e.g., CNC Milling I" required>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label"><strong>Module Code</strong></label>
            <input class="form-control" name="module_code" placeholder="e.g., 652201-000-01-00-PM-15">
          </div>
        </div>
        <div class="row">
          <div class="col-md-4 mb-3">
            <label class="form-label"><strong>Category</strong></label>
            <select class="form-select" name="module_category">
              <option value="">-- Select Category --</option>
              <option value="FUNDAMENTALS">FUNDAMENTALS</option>
              <option value="TOOLING U">TOOLING U</option>
              <option value="THEORY MODULES">THEORY MODULES</option>
              <option value="PRACTICAL MODULES">PRACTICAL MODULES</option>
            </select>
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label"><strong>Status Type</strong></label>
            <select class="form-select" name="module_status_type">
              <option value="P/NYP">P/NYP (Pass/Not Yet Passed)</option>
              <option value="C/NYC">C/NYC (Complete/Not Yet Complete)</option>
            </select>
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label"><strong>Credits</strong></label>
            <input class="form-control" name="module_credits" placeholder="e.g., 75%, 60%">
          </div>
        </div>
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-plus-circle me-1"></i>Add Module
        </button>
      </form>
    </div>
  </div>

  <!-- Existing Modules Table -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-success text-white">
      <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Existing Modules ({{ modules|length }})</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover table-striped">
          <thead class="table-dark">
            <tr>
              <th width="50">ID</th>
              <th>Module Name</th>
              <th>Code</th>
              <th>Category</th>
              <th>Status Type</th>
              <th>Credits</th>
              <th width="150">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for m in modules %}
            <tr>
              <td><strong>{{ m.id }}</strong></td>
              <td>{{ m.name }}</td>
              <td><small class="text-muted">{{ m.code if m.code else '-' }}</small></td>
              <td>
                {% if m.category %}
                  <span class="badge bg-info">{{ m.category }}</span>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
              <td>
                {% if m.status_type == 'P/NYP' %}
                  <span class="badge bg-primary">P/NYP</span>
                {% elif m.status_type == 'C/NYC' %}
                  <span class="badge bg-warning text-dark">C/NYC</span>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
              <td><small>{{ m.credits if m.credits else '-' }}</small></td>
              <td>
                <a href="{{ url_for('edit_module', mod_id=m.id) }}" class="btn btn-sm btn-outline-primary">
                  <i class="bi bi-pencil"></i> Edit
                </a>
                <form method="POST" action="{{ url_for('delete_module', mod_id=m.id) }}" class="d-inline" 
                      onsubmit="return confirm('Delete module \'{{ m.name }}\'? This will also delete all associated mini-tasks!');">
                  <button type="submit" class="btn btn-sm btn-outline-danger">
                    <i class="bi bi-trash"></i>
                  </button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Add Mini-Task Card -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-secondary text-white">
      <h5 class="mb-0"><i class="bi bi-plus-square me-2"></i>Add Mini-Task to Module</h5>
    </div>
    <div class="card-body">
      <form method="POST" action="{{ url_for('add_mini_task') }}">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="moduleSelect" class="form-label"><strong>Select Module</strong> <span class="text-danger">*</span></label>
            <select class="form-select" name="module_id" id="moduleSelect" required>
              <option value="">-- Select Module --</option>
              {% for m in modules %}
              <option value="{{ m.id }}">{{ m.name }} {% if m.code %}({{ m.code }}){% endif %}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label"><strong>Mini-Task Title</strong> <span class="text-danger">*</span></label>
            <input class="form-control" name="title" placeholder="e.g., Online, MT, IWP, CWP" required>
            <small class="text-muted">Common types: Online, MT, MT1, MT2, IWP, CWP</small>
          </div>
        </div>
        <button type="submit" class="btn btn-secondary">
          <i class="bi bi-plus-square me-1"></i>Add Mini-Task
        </button>
      </form>
    </div>
  </div>

  <!-- Existing Mini-Tasks Table -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-info text-white">
      <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>Existing Mini-Tasks ({{ mini_tasks|length }})</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover table-bordered">
          <thead class="table-dark">
            <tr>
              <th width="50">ID</th>
              <th>Title</th>
              <th>Module</th>
              <th>Category</th>
              <th width="100">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for mt in mini_tasks %}
            <tr>
              <td><strong>{{ mt.id }}</strong></td>
              <td>{{ mt.title }}</td>
              <td>{{ mt.module.name if mt.module else '<span class="text-danger">No Module</span>' }}</td>
              <td>
                {% if mt.module and mt.module.category %}
                  <span class="badge bg-info">{{ mt.module.category }}</span>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
              <td>
                <form method="POST" action="{{ url_for('delete_mini_task', mt_id=mt.id) }}" class="d-inline"
                      onsubmit="return confirm('Delete mini-task \'{{ mt.title }}\'?');">
                  <button type="submit" class="btn btn-sm btn-outline-danger">
                    <i class="bi bi-trash"></i>
                  </button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}

