{% extends 'base.html' %}
{% block title %}Module Assignments{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row mb-4">
    <div class="col-12">
      <h2><i class="bi bi-list-check me-2"></i>Module Assignments</h2>
      <p class="text-muted">View and manage student module enrollments</p>
    </div>
  </div>

  <div class="row mb-3">
    <div class="col-md-12">
      <a href="{{ url_for('assign_modules_bulk') }}" class="btn btn-primary">
        <i class="bi bi-plus-circle me-2"></i>Assign Modules
      </a>
      <a href="{{ url_for('modules_page') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left me-2"></i>Back to Modules
      </a>
    </div>
  </div>

  <div class="row">
    <div class="col-md-12">
      <div class="card shadow-sm">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0"><i class="bi bi-table me-2"></i>Student-Module Assignments</h5>
        </div>
        <div class="card-body">
          <!-- Filter Options -->
          <div class="row mb-3">
            <div class="col-md-6">
              <input type="text" class="form-control" id="searchInput" placeholder="Search students..." onkeyup="filterTable()">
            </div>
            <div class="col-md-6">
              <select class="form-select" id="viewMode" onchange="switchView()">
                <option value="student">By Student</option>
                <option value="module">By Module</option>
              </select>
            </div>
          </div>

          <!-- By Student View -->
          <div id="studentView">
            <div class="table-responsive">
              <table class="table table-striped table-hover" id="assignmentTable">
                <thead class="table-dark">
                  <tr>
                    <th>Student</th>
                    <th>Student Number</th>
                    <th>Group</th>
                    <th>Assigned Modules</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for student in students %}
                  <tr>
                    <td>{{ student.student_name }}</td>
                    <td>{{ student.student_number or 'N/A' }}</td>
                    <td>{{ student.group.name if student.group else 'N/A' }}</td>
                    <td>
                      {% if student.enrolled_modules %}
                        {% for module in student.enrolled_modules %}
                          <span class="badge bg-primary me-1 mb-1">{{ module.name }}</span>
                        {% endfor %}
                        <br><small class="text-muted">({{ student.enrolled_modules|length }} module(s))</small>
                      {% else %}
                        <span class="text-muted">No modules assigned</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if student.enrolled_modules %}
                        <button class="btn btn-sm btn-danger" onclick="showRemoveModal('{{ student.id }}', '{{ student.student_name }}')">
                          <i class="bi bi-trash"></i> Remove
                        </button>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <!-- By Module View -->
          <div id="moduleView" style="display: none;">
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead class="table-dark">
                  <tr>
                    <th>Module</th>
                    <th>Code</th>
                    <th>Category</th>
                    <th>Enrolled Students</th>
                  </tr>
                </thead>
                <tbody>
                  {% for module in modules %}
                  <tr>
                    <td>{{ module.name }}</td>
                    <td>{{ module.code or 'N/A' }}</td>
                    <td>{{ module.category or 'N/A' }}</td>
                    <td>
                      {% if module.enrolled_students %}
                        {% for student in module.enrolled_students %}
                          <span class="badge bg-success me-1 mb-1">{{ student.student_name }}</span>
                        {% endfor %}
                        <br><small class="text-muted">({{ module.enrolled_students|length }} student(s))</small>
                      {% else %}
                        <span class="text-muted">No students enrolled</span>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Remove Assignment Modal -->
<div class="modal fade" id="removeModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Remove Module Assignment</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form method="POST" action="{{ url_for('remove_module_assignment') }}" id="removeForm">
          <input type="hidden" name="student_id" id="removeStudentId">
          
          <p>Select module to remove for <strong id="studentNameDisplay"></strong>:</p>
          
          <div id="modulesList"></div>
          
          <div class="mt-3">
            <button type="submit" class="btn btn-danger">
              <i class="bi bi-trash me-2"></i>Remove Assignment
            </button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
function filterTable() {
  const input = document.getElementById('searchInput');
  const filter = input.value.toUpperCase();
  const table = document.getElementById('assignmentTable');
  const tr = table.getElementsByTagName('tr');
  
  for (let i = 1; i < tr.length; i++) {
    const td = tr[i].getElementsByTagName('td')[0];
    if (td) {
      const txtValue = td.textContent || td.innerText;
      if (txtValue.toUpperCase().indexOf(filter) > -1) {
        tr[i].style.display = '';
      } else {
        tr[i].style.display = 'none';
      }
    }
  }
}

function switchView() {
  const viewMode = document.getElementById('viewMode').value;
  if (viewMode === 'student') {
    document.getElementById('studentView').style.display = 'block';
    document.getElementById('moduleView').style.display = 'none';
  } else {
    document.getElementById('studentView').style.display = 'none';
    document.getElementById('moduleView').style.display = 'block';
  }
}

function showRemoveModal(studentId, studentName) {
  document.getElementById('removeStudentId').value = studentId;
  document.getElementById('studentNameDisplay').textContent = studentName;
  
  // Fetch student's modules
  fetch(`/api/student_modules/${studentId}`)
    .then(response => response.json())
    .then(modules => {
      const modulesList = document.getElementById('modulesList');
      modulesList.innerHTML = '';
      
      modules.forEach(module => {
        const div = document.createElement('div');
        div.className = 'form-check';
        div.innerHTML = `
          <input class="form-check-input" type="radio" name="module_id" value="${module.id}" id="module${module.id}" required>
          <label class="form-check-label" for="module${module.id}">
            ${module.name}
          </label>
        `;
        modulesList.appendChild(div);
      });
      
      const modal = new bootstrap.Modal(document.getElementById('removeModal'));
      modal.show();
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error loading modules');
    });
}
</script>
{% endblock %}
