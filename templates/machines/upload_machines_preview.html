{% extends 'base.html' %}
{% block title %}Preview Machine Upload{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row mb-4">
    <div class="col-12">
      <h2><i class="bi bi-cloud-upload me-2"></i>Upload Machines - Preview & Confirm</h2>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{{ url_for('machines_list') }}">Machines</a></li>
          <li class="breadcrumb-item"><a href="{{ url_for('machines_upload_form') }}">Upload</a></li>
          <li class="breadcrumb-item active">Preview</li>
        </ol>
      </nav>
    </div>
  </div>

  <form method="POST" action="{{ url_for('upload_machines_confirm') }}">
    <input type="hidden" name="filename" value="{{ filename }}">
    <input type="hidden" name="header_row" value="{{ header_row }}">

    <div class="card shadow-sm mb-4">
      <div class="card-header bg-success text-white">
        <h5 class="mb-0"><i class="bi bi-check-circle me-2"></i>File Information</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-4">
            <strong><i class="bi bi-file-earmark me-1"></i>Filename:</strong><br>
            <span class="text-muted">{{ filename }}</span>
          </div>
          <div class="col-md-4">
            <strong><i class="bi bi-list-ol me-1"></i>Total Rows:</strong><br>
            <span class="badge bg-primary">{{ total_rows }} machines</span>
          </div>
          <div class="col-md-4">
            <strong><i class="bi bi-arrow-down me-1"></i>Header Row:</strong><br>
            <span class="badge bg-secondary">Row {{ header_row + 1 }}</span>
          </div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm mb-4">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="bi bi-table me-2"></i>Detected Columns</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-bordered">
            <thead class="table-light">
              <tr>
                <th>Column Name</th>
                <th>Type</th>
                <th>Sample Data</th>
              </tr>
            </thead>
            <tbody>
              {% for col in columns %}
              <tr>
                <td>
                  <strong>{{ col }}</strong>
                  {% if col in ['Machine Name', 'machine_name', 'MACHINE NAME', 'Machine_Name'] %}
                    <span class="badge bg-success ms-2">Required</span>
                  {% elif col in ['Level', 'level', 'LEVEL'] %}
                    <span class="badge bg-info ms-2">Built-in</span>
                  {% else %}
                    <span class="badge bg-warning ms-2">Custom Field</span>
                  {% endif %}
                </td>
                <td>
                  {% if col not in ['Machine Name', 'machine_name', 'MACHINE NAME', 'Machine_Name', 'Level', 'level', 'LEVEL'] %}
                    <select name="field_type_{{ col }}" class="form-select form-select-sm">
                      <option value="text">Text</option>
                      <option value="number">Number</option>
                      <option value="date">Date</option>
                      <option value="boolean">Yes/No</option>
                    </select>
                  {% else %}
                    <span class="text-muted">Built-in</span>
                  {% endif %}
                </td>
                <td>
                  <small class="text-muted">
                    {% if preview_data %}
                      {{ preview_data[0].get(col, '') }}
                    {% endif %}
                  </small>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        {% if custom_columns %}
        <div class="alert alert-warning mt-3">
          <h6><i class="bi bi-exclamation-triangle me-2"></i>Custom Fields Detected:</h6>
          <p class="mb-2">The following columns will be created as custom fields:</p>
          <div class="mb-2">
            {% for col in custom_columns %}
              <label class="form-check">
                <input class="form-check-input" type="checkbox" name="dynamic_fields" value="{{ col }}" checked>
                <span class="form-check-label">
                  <strong>{{ col }}</strong>
                  {% if col in existing_field_names %}
                    <span class="badge bg-info">Already exists</span>
                  {% else %}
                    <span class="badge bg-success">New</span>
                  {% endif %}
                </span>
              </label>
            {% endfor %}
          </div>
          <small class="text-muted">Uncheck any fields you don't want to import</small>
        </div>
        {% endif %}
      </div>
    </div>

    <div class="card shadow-sm mb-4">
      <div class="card-header bg-info text-white">
        <h5 class="mb-0"><i class="bi bi-eye me-2"></i>Data Preview (First 5 Rows)</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped table-hover table-sm">
            <thead>
              <tr>
                {% for col in columns %}
                <th>{{ col }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for row in preview_data %}
              <tr>
                {% for col in columns %}
                <td>{{ row.get(col, '') }}</td>
                {% endfor %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="alert alert-success">
      <h5><i class="bi bi-info-circle me-2"></i>Ready to Import</h5>
      <p class="mb-0">Click "Confirm & Import" to add these machines to your system.</p>
    </div>

    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
      <a href="{{ url_for('machines_upload_form') }}" class="btn btn-secondary">
        <i class="bi bi-x-circle me-1"></i>Cancel
      </a>
      <button type="submit" class="btn btn-success btn-lg">
        <i class="bi bi-check-circle me-1"></i>Confirm & Import Machines
      </button>
    </div>
  </form>
</div>
{% endblock %}
