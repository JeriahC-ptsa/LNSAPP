{% extends 'base.html' %}
{% block title %}Manage Roles & Permissions{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <h1 class="mb-4"><i class="bi bi-shield-lock me-2"></i>Role & Permission Management</h1>

  <div class="row">
    <!-- Roles List -->
    <div class="col-md-4">
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-people-fill me-2"></i>Roles</h5>
          <button class="btn btn-sm btn-light" data-bs-toggle="modal" data-bs-target="#addRoleModal">
            <i class="bi bi-plus-circle"></i> Add Role
          </button>
        </div>
        <div class="card-body">
          <div class="list-group">
            {% for role in roles %}
            <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center role-item"
               data-role-id="{{ role.id }}" onclick="loadRolePermissions({{ role.id }}, '{{ role.name }}', '{{ role.description }}')">
              <div>
                <h6 class="mb-0">{{ role.name }}</h6>
                <small class="text-muted">{{ role.description or 'No description' }}</small>
              </div>
              <span class="badge bg-info rounded-pill">{{ role.permissions|length }}</span>
            </a>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <!-- Permission Assignment -->
    <div class="col-md-8">
      <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="bi bi-key-fill me-2"></i>Permissions for: <span id="selectedRoleName">Select a role</span></h5>
        </div>
        <div class="card-body">
          <div id="noRoleSelected" class="text-center text-muted py-5">
            <i class="bi bi-arrow-left" style="font-size: 3rem;"></i>
            <p class="mt-3">Select a role from the left to manage its permissions</p>
          </div>

          <div id="rolePermissions" style="display: none;">
            <!-- Role Actions -->
            <div class="mb-3 d-flex gap-2">
              <button class="btn btn-warning" onclick="editRole()">
                <i class="bi bi-pencil"></i> Edit Role
              </button>
              <button class="btn btn-danger" onclick="deleteRole()">
                <i class="bi bi-trash"></i> Delete Role
              </button>
            </div>

            <form id="permissionsForm" onsubmit="savePermissions(event)">
              <input type="hidden" id="currentRoleId">
              
              <div class="mb-4">
                <h6 class="border-bottom pb-2">Page Access Permissions</h6>
                <div class="row">
                  {% for perm in all_permissions %}
                    {% if perm.type == 'page_access' %}
                    <div class="col-md-6 mb-2">
                      <div class="form-check">
                        <input class="form-check-input permission-checkbox" type="checkbox" 
                               id="perm_{{ perm.id }}" name="permissions" value="{{ perm.id }}">
                        <label class="form-check-label" for="perm_{{ perm.id }}">
                          <strong>{{ perm.name }}</strong>
                          <br><small class="text-muted">{{ perm.description }}</small>
                        </label>
                      </div>
                    </div>
                    {% endif %}
                  {% endfor %}
                </div>
              </div>

              <div class="mb-4">
                <h6 class="border-bottom pb-2">Function Permissions</h6>
                <div class="row">
                  {% for perm in all_permissions %}
                    {% if perm.type == 'function' %}
                    <div class="col-md-6 mb-2">
                      <div class="form-check">
                        <input class="form-check-input permission-checkbox" type="checkbox" 
                               id="perm_{{ perm.id }}" name="permissions" value="{{ perm.id }}">
                        <label class="form-check-label" for="perm_{{ perm.id }}">
                          <strong>{{ perm.name }}</strong>
                          <br><small class="text-muted">{{ perm.description }}</small>
                        </label>
                      </div>
                    </div>
                    {% endif %}
                  {% endfor %}
                </div>
              </div>

              <div class="mb-3">
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="selectAllPermissions()">
                  <i class="bi bi-check-all"></i> Select All
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="deselectAllPermissions()">
                  <i class="bi bi-x-circle"></i> Deselect All
                </button>
              </div>

              <button type="submit" class="btn btn-success btn-lg">
                <i class="bi bi-save"></i> Save Permissions
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Role Modal -->
<div class="modal fade" id="addRoleModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>Add New Role</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form action="{{ url_for('auth.create_role') }}" method="POST">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Role Name <span class="text-danger">*</span></label>
            <input type="text" class="form-control" name="role_name" required 
                   placeholder="e.g., Lab Assistant, Student Advisor">
          </div>
          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea class="form-control" name="description" rows="3" 
                      placeholder="Describe what this role is for..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Role</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Role Modal -->
<div class="modal fade" id="editRoleModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title"><i class="bi bi-pencil me-2"></i>Edit Role</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form action="{{ url_for('auth.update_role') }}" method="POST">
        <input type="hidden" id="editRoleId" name="role_id">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Role Name <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="editRoleName" name="role_name" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea class="form-control" id="editRoleDescription" name="description" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-warning">Update Role</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
let currentRoleId = null;
let currentRoleName = null;
let currentRoleDescription = null;

function loadRolePermissions(roleId, roleName, roleDescription) {
  currentRoleId = roleId;
  currentRoleName = roleName;
  currentRoleDescription = roleDescription;
  
  document.getElementById('currentRoleId').value = roleId;
  document.getElementById('selectedRoleName').textContent = roleName;
  document.getElementById('noRoleSelected').style.display = 'none';
  document.getElementById('rolePermissions').style.display = 'block';
  
  // Highlight selected role
  document.querySelectorAll('.role-item').forEach(item => {
    item.classList.remove('active');
  });
  event.currentTarget.classList.add('active');
  
  // Fetch role permissions
  fetch(`/admin/role/${roleId}/permissions`)
    .then(response => response.json())
    .then(data => {
      // Uncheck all checkboxes first
      document.querySelectorAll('.permission-checkbox').forEach(cb => {
        cb.checked = false;
      });
      
      // Check the permissions this role has
      data.permission_ids.forEach(permId => {
        const checkbox = document.getElementById(`perm_${permId}`);
        if (checkbox) {
          checkbox.checked = true;
        }
      });
    });
}

function savePermissions(event) {
  event.preventDefault();
  
  const roleId = document.getElementById('currentRoleId').value;
  const selectedPermissions = [];
  
  document.querySelectorAll('.permission-checkbox:checked').forEach(cb => {
    selectedPermissions.push(cb.value);
  });
  
  fetch(`/admin/role/${roleId}/permissions`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      permission_ids: selectedPermissions
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('Permissions saved successfully!');
      location.reload();
    } else {
      alert('Error saving permissions: ' + data.message);
    }
  });
}

function selectAllPermissions() {
  document.querySelectorAll('.permission-checkbox').forEach(cb => {
    cb.checked = true;
  });
}

function deselectAllPermissions() {
  document.querySelectorAll('.permission-checkbox').forEach(cb => {
    cb.checked = false;
  });
}

function editRole() {
  document.getElementById('editRoleId').value = currentRoleId;
  document.getElementById('editRoleName').value = currentRoleName;
  document.getElementById('editRoleDescription').value = currentRoleDescription;
  new bootstrap.Modal(document.getElementById('editRoleModal')).show();
}

function deleteRole() {
  if (!confirm(`Are you sure you want to delete the role "${currentRoleName}"? This action cannot be undone.`)) {
    return;
  }
  
  fetch(`/admin/role/${currentRoleId}`, {
    method: 'DELETE'
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('Role deleted successfully!');
      location.reload();
    } else {
      alert('Error deleting role: ' + data.message);
    }
  });
}
</script>
{% endblock %}
