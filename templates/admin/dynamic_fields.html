{% extends 'base.html' %}
{% block title %}Dynamic Fields Management{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <h2><i class="bi bi-input-cursor-text me-2"></i>Dynamic Fields Management</h2>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addFieldModal">
          <i class="bi bi-plus-circle me-1"></i>Add New Field
        </button>
      </div>
    </div>
  </div>

  <!-- Info Alert -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>
        <strong>About Dynamic Fields:</strong> These are custom fields you can add beyond the built-in model fields. 
        For example, for Students, you can add fields like Gender, Race, Area of Residence, etc.
      </div>
    </div>
  </div>

  <!-- Fields by Model -->
  {% for model_name in models %}
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <h5 class="mb-0"><i class="bi bi-table me-2"></i>{{ model_name }} Fields</h5>
        </div>
        <div class="card-body">
          <!-- Built-in Fields Info -->
          <div class="mb-3">
            <h6 class="text-muted"><i class="bi bi-lock me-1"></i>Built-in Fields (Cannot be modified):</h6>
            <div class="d-flex flex-wrap gap-2">
              {% if model_name == 'Student' %}
                <span class="badge bg-secondary">student_name</span>
                <span class="badge bg-secondary">level</span>
                <span class="badge bg-secondary">mark</span>
                <span class="badge bg-secondary">group_id</span>
              {% elif model_name == 'Machine' %}
                <span class="badge bg-secondary">name</span>
                <span class="badge bg-secondary">manufacturer</span>
                <span class="badge bg-secondary">type</span>
                <span class="badge bg-secondary">status</span>
              {% elif model_name == 'Module' %}
                <span class="badge bg-secondary">name</span>
                <span class="badge bg-secondary">code</span>
                <span class="badge bg-secondary">description</span>
              {% elif model_name == 'Lecturer' %}
                <span class="badge bg-secondary">name</span>
                <span class="badge bg-secondary">email</span>
                <span class="badge bg-secondary">phone_number</span>
              {% endif %}
            </div>
          </div>

          <hr>

          <!-- Dynamic Fields -->
          <h6 class="text-primary"><i class="bi bi-plus-square me-1"></i>Custom Dynamic Fields:</h6>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Field Name</th>
                  <th>Field Type</th>
                  <th>Required</th>
                  <th>Options</th>
                  <th>Created</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% set model_fields = fields | selectattr('model_name', 'equalto', model_name) | list %}
                {% if model_fields %}
                  {% for field in model_fields %}
                  <tr>
                    <td><strong>{{ field.field_name }}</strong></td>
                    <td>
                      <span class="badge bg-info">{{ field.field_type }}</span>
                    </td>
                    <td>
                      {% if field.required %}
                        <span class="badge bg-warning">Required</span>
                      {% else %}
                        <span class="badge bg-secondary">Optional</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if field.field_options and field.field_options != '[]' %}
                        <small>{{ field.field_options }}</small>
                      {% else %}
                        <small class="text-muted">-</small>
                      {% endif %}
                    </td>
                    <td>{{ field.created_at.strftime('%Y-%m-%d') }}</td>
                    <td>
                      <button class="btn btn-sm btn-outline-danger" onclick="deleteField('{{ field.id }}')">
                        <i class="bi bi-trash"></i> Delete
                      </button>
                    </td>
                  </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="6" class="text-center text-muted py-3">
                      <i class="bi bi-inbox"></i>
                      <p class="mb-0 small">No custom fields added yet. Click "Add New Field" to create one.</p>
                    </td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<!-- Add Field Modal -->
<div class="modal fade" id="addFieldModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-plus-square me-2"></i>Add New Dynamic Field</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addFieldForm">
          <div class="mb-3">
            <label for="modelName" class="form-label">Select Model</label>
            <select class="form-select" id="modelName" required>
              <option value="">Choose a model...</option>
              {% for model in models %}
              <option value="{{ model }}">{{ model }}</option>
              {% endfor %}
            </select>
          </div>
          
          <div class="mb-3">
            <label for="fieldName" class="form-label">Field Name</label>
            <input type="text" class="form-control" id="fieldName" required
                   placeholder="e.g., gender, race, area_of_residence"
                   pattern="[a-z_]+" title="Use lowercase letters and underscores only">
            <small class="text-muted">Use snake_case (lowercase with underscores)</small>
          </div>
          
          <div class="mb-3">
            <label for="fieldType" class="form-label">Field Type</label>
            <select class="form-select" id="fieldType" required onchange="toggleOptionsInput()">
              <option value="">Choose type...</option>
              <option value="text">Text</option>
              <option value="number">Number</option>
              <option value="date">Date</option>
              <option value="select">Select (Dropdown)</option>
              <option value="boolean">Yes/No</option>
            </select>
          </div>
          
          <div class="mb-3" id="optionsContainer" style="display: none;">
            <label for="fieldOptions" class="form-label">Options (for Select type)</label>
            <input type="text" class="form-control" id="fieldOptions"
                   placeholder="Enter options separated by commas (e.g., Male, Female, Other)">
            <small class="text-muted">Comma-separated list of options</small>
          </div>
          
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="fieldRequired">
            <label class="form-check-label" for="fieldRequired">
              Required field
            </label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveField()">
          <i class="bi bi-save me-1"></i>Save Field
        </button>
      </div>
    </div>
  </div>
</div>

<script>
function toggleOptionsInput() {
  const fieldType = document.getElementById('fieldType').value;
  const optionsContainer = document.getElementById('optionsContainer');
  
  if (fieldType === 'select') {
    optionsContainer.style.display = 'block';
  } else {
    optionsContainer.style.display = 'none';
    document.getElementById('fieldOptions').value = '';
  }
}

function saveField() {
  const modelName = document.getElementById('modelName').value;
  const fieldName = document.getElementById('fieldName').value;
  const fieldType = document.getElementById('fieldType').value;
  const fieldRequired = document.getElementById('fieldRequired').checked;
  const fieldOptions = document.getElementById('fieldOptions').value;
  
  if (!modelName || !fieldName || !fieldType) {
    alert('Please fill in all required fields');
    return;
  }
  
  // Validate field name format
  if (!/^[a-z_]+$/.test(fieldName)) {
    alert('Field name must contain only lowercase letters and underscores');
    return;
  }
  
  const data = {
    model_name: modelName,
    field_name: fieldName,
    field_type: fieldType,
    required: fieldRequired,
    field_options: fieldType === 'select' ? fieldOptions.split(',').map(o => o.trim()) : []
  };
  
  fetch('/admin/dynamic-fields/add', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(result => {
    if (result.success) {
      alert('Field added successfully');
      location.reload();
    } else {
      alert('Error adding field: ' + (result.message || 'Unknown error'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error adding field');
  });
}

function deleteField(fieldId) {
  if (!confirm('Are you sure you want to delete this field? All data for this field will be lost.')) {
    return;
  }
  
  fetch(`/admin/dynamic-fields/${fieldId}/delete`, {
    method: 'DELETE',
    headers: {
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(result => {
    if (result.success) {
      alert('Field deleted successfully');
      location.reload();
    } else {
      alert('Error deleting field');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error deleting field');
  });
}
</script>
{% endblock %}
